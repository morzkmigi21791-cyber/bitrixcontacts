<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–æ–º–ø–∞–Ω–∏–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã Bitrix24</title>
</head>
<body>
<h1>–ö–æ–º–ø–∞–Ω–∏–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã Bitrix24</h1>
<div id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<div id="content"></div>

<script>
const WEBHOOK = "https://b24-lkgkv0.bitrix24.ru/rest/1/90qyb3sbcjem26bq/";

async function apiCall(method, params = {}) {
    const response = await fetch(`${WEBHOOK}${method}.json`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(params)
    });
    const data = await response.json();
    if (data.error) {
        throw new Error(`${data.error}: ${data.error_description || ''}`);
    }
    return data;
}

async function getAllCompanies() {
    const companies = [];
    let start = 0;
    let hasMore = true;

    while (hasMore) {
        console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–ø–∞–Ω–∏–∏ —Å ${start}...`);
        const data = await apiCall("crm.company.list", {
            start: start,
            select: ["ID", "TITLE", "PHONE", "EMAIL"]
        });

        companies.push(...(data.result || []));
        hasMore = data.next !== undefined;
        start += 50;
    }

    return companies;
}

async function getContactsForCompany(companyId) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º —Å–≤—è–∑–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —Å –∫–æ–º–ø–∞–Ω–∏–µ–π
        const linksData = await apiCall("crm.company.contact.items.get", {
            id: companyId
        });

        const contacts = [];
        for (const link of linksData.result || []) {
            try {
                const contactData = await apiCall("crm.contact.get", {
                    id: link.CONTACT_ID,
                    select: ["ID", "NAME", "LAST_NAME", "PHONE", "EMAIL", "POST"]
                });
                if (contactData.result) {
                    contacts.push(contactData.result);
                }
            } catch (error) {
                console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ ${link.CONTACT_ID}:`, error);
            }
        }

        return contacts;
    } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ ${companyId}:`, error);
        return [];
    }
}

function addCompanyToPage(company, contacts) {
    const content = document.getElementById('content');

    const companyDiv = document.createElement('div');
    companyDiv.style.border = '1px solid #ccc';
    companyDiv.style.margin = '10px 0';
    companyDiv.style.padding = '10px';

    let companyInfo = `<h3>üè¢ ${company.TITLE} (ID: ${company.ID})</h3>`;

    if (company.PHONE && company.PHONE[0]) {
        companyInfo += `<p>üìû ${company.PHONE[0].VALUE}</p>`;
    }
    if (company.EMAIL && company.EMAIL[0]) {
        companyInfo += `<p>‚úâÔ∏è ${company.EMAIL[0].VALUE}</p>`;
    }

    companyInfo += `<h4>–ö–æ–Ω—Ç–∞–∫—Ç—ã (${contacts.length}):</h4>`;

    if (contacts.length === 0) {
        companyInfo += '<p>–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>';
    } else {
        companyInfo += '<ul>';
        for (const contact of contacts) {
            let contactInfo = `üë§ ${contact.NAME || ''} ${contact.LAST_NAME || ''}`;
            if (contact.PHONE && contact.PHONE[0]) {
                contactInfo += ` - üìû ${contact.PHONE[0].VALUE}`;
            }
            if (contact.EMAIL && contact.EMAIL[0]) {
                contactInfo += ` - ‚úâÔ∏è ${contact.EMAIL[0].VALUE}`;
            }
            if (contact.POST) {
                contactInfo += ` - üíº ${contact.POST}`;
            }
            companyInfo += `<li>${contactInfo}</li>`;
        }
        companyInfo += '</ul>';
    }

    companyDiv.innerHTML = companyInfo;
    content.appendChild(companyDiv);
}

async function loadAllData() {
    const statusDiv = document.getElementById('status');

    try {
        statusDiv.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏...';
        const companies = await getAllCompanies();

        statusDiv.textContent = `–ù–∞–π–¥–µ–Ω–æ ${companies.length} –∫–æ–º–ø–∞–Ω–∏–π. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã...`;

        for (let i = 0; i < companies.length; i++) {
            const company = companies[i];
            statusDiv.textContent = `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–ø–∞–Ω–∏—é ${i + 1}/${companies.length}: ${company.TITLE}`;

            const contacts = await getContactsForCompany(company.ID);
            addCompanyToPage(company, contacts);

            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å API
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        statusDiv.textContent = `‚úÖ –ì–æ—Ç–æ–≤–æ! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${companies.length} –∫–æ–º–ø–∞–Ω–∏–π.`;

    } catch (error) {
        statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
        console.error('–û—à–∏–±–∫–∞:', error);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
loadAllData();
</script>
</body>
</html>
